{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_filters %}

{% block title %}
    {{ ticker.name }}
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <div>
        <p> Name : {{ ticker.name }}</p>
        <br>
        <p> Symbol : {{ ticker.symbol }} </p>
        <br>
        <p> Bid Price : {{ ticker.bid }} </p>
        <br>
        <p> Ask Price : {{ ticker.ask }} </p>
        <br>
        <p>Username : {{ user.username }} </p>
        <br>
        <p>Your Free Margin : {{ user.profile.free_margin |floatformat:3 }} </p>
        <br>
        <h1>
            {{ state_open_order_status }}
        </h1>
        <!-- Open-->
        <div class="input-group mb-3">
            <form method="post">
                {% csrf_token %}
                <span class="input-group-text">Input Price</span>
                <p>{{ order_open_position_form.input_price|as_crispy_field }}</p>
                <span class="input-group-text">$</span>

                <button name="open_order" type="submit">Open Position</button>
            </form>
        </div>
        <!-- Open Positions-->
        <h1>
            Your Open Positions:
        </h1>
        <!-- Open Positions Table-->
    <table id="tableOpenPositions" class="table table-striped table-bordered table-sm" cellspacing="0" width="90%">
        <thead>
        <tr>
            <th class="th-sm">Symbol</th>
            <th class="th-sm">Direction</th>
            <th class="th-sm">Initial Qty.</th>
            <th class="th-sm">Current Qty.</th>
            <th class="th-sm">Input Price</th>
            <th class="th-sm">Blocked Margin</th>
            <th class="th-sm">Unrealized Gain</th>
        </tr>
        </thead>
        <tbody>
        {% for open_position in open_positions %}
            <tr>
                <td>{{ open_position.symbol }}</td>
                <td>{{ open_position.get_direction_display }}</td>
                <td>{{ open_position.initial_quantity }}</td>
                <td>{{ open_position.current_quantity }}</td>
                <td>{{ open_position.input_price }}</td>
                <td>{{ open_position.blocked_margin }}</td>
                <td>{{ open_position.unrealized_gain }}</td>
            </tr>
        {% endfor %}

        </tbody>
        <tfoot>
        <tr>
            <th>Symbol</th>
            <th>Direction</th>
            <th>Initial Qty.</th>
            <th>Current Qty.</th>
            <th>Input Price</th>
            <th>Blocked Margin</th>
            <th>Unrealized Gain</th>
        </tr>
        </tfoot>
    </table>

        <br>
        <h1>
            {{ state_close_order_status }}
        </h1>
        <form method="post">
            {% csrf_token %}
            {{ order_close_position_form.as_p }}
            <button name="close_order" type="submit">Close Position</button>
        </form>

        <h1>
            All published posts about {{ ticker.name }}

        </h1>

        <div>
            {% for post in all_posts %}
                <p>
                    Username : {{ post.user.username }}
                </p>
                <p>
                    Date : {{ post.created_datetime }}
                </p>
                <p>
                    Bid price at the moment of publish : {{ post.related_symbol.bid }}
                </p><p>
                Ask price at the moment of publish : {{ post.related_symbol.ask }}
            </p>
                <p>
                    Text : {{ post.text_content }}
                </p>
                <p>
                    Number of Likes : {{ post.number_of_likes }}
                </p>

                {% if user in post.like_related_users %}
                    <a href="/unlike/{{ post.id }}">Liked</a>
                {% else %}
                    <a href="/like/{{ post.id }}">Like</a>
                {% endif %}]
                <br>
            {% endfor %}

        </div>

        <h1>
            {{ state_post_status }}
        </h1>

        <form method="post">
            {% csrf_token %}
            {{ post_form.as_p }}
            <button name="post" type="submit">Post</button>
        </form>
    </div>

{% endblock %}
{% block extra_scripts %}
    <script src="{% static 'paper_trade/datatable.js' %}"></script>
{% endblock %}